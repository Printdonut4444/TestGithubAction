name: "Robot: Auto Delete Branch"

on:
  pull_request:
    types: [assigned, unassigned, labeled, unlabeled, opened, edited, closed, reopened, synchronize, converted_to_draft, locked, unlocked, enqueued, dequeued, milestoned, demilestoned, ready_for_review, review_requested, review_request_removed, auto_merge_enabled, auto_merge_disabled]

jobs:
  auto-delete-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "1. ตรวจสอบชื่อ branch ที่จะลบ"
        run: |
          TARGET="${{ github.event.pull_request.head.ref }}"
          echo "PR ถูก Merge แล้ว! กำลังเตรียมลบ branch: $TARGET"
          
          # ป้องกันไม่ให้ลบกิ่งหลัก (เผื่อไว้)
          if [ "$TARGET" == "main" ] || [ "$TARGET" == "develop" ]; then
            echo "ไม่สามารถลบกิ่งหลักได้"
            exit 1
          fi
          echo "target_branch=$TARGET" >> $GITHUB_ENV

      - name: "2. สั่งลบ branch อัตโนมัติ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/heads/${{ env.target_branch }}"