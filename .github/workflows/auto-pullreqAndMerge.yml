name: Auto Create Pull Request project Management

on:
  push:
    branches-ignore:
      - 'main'
      - '87-gg'

jobs:
  # Job 1: สร้าง PR และ Merge 
  create-and-merge:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      pull-requests: write
    outputs:
      pr_number: ${{ steps.cpr_step.outputs.pr_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Pull Request
        id: cpr_step
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "${{ github.ref_name }}" # ดึงชื่อ Branch มาใช้
          destination_branch: "main"
          pr_title: "PR: พัฒนาฟีเจอร์สำหรับ Issue #${{ github.ref_name }}"
          # ใส่คำว่า closes # แล้วตามด้วยชื่อกิ่ง (ซึ่งเราจะตั้งเป็นตัวเลข)
          pr_body: |
            closes #${{ github.ref_name }}
            สร้างและรวมร่างอัตโนมัติโดย GitHub Action
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for changes
        run: |
          if [ -z "${{ steps.cpr_step.outputs.pr_number }}" ]; then
            echo "⚠️ ไม่พบการเปลี่ยนแปลง (ไฟล์ซ้ำกัน)"
            echo "จะไม่มีการ Merge เกิดขึ้น"
          else
            echo "✅ พบของใหม่! สร้าง PR หมายเลข ${{ steps.cpr_step.outputs.pr_number }} แล้ว"
          fi